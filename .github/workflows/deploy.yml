# Автодеплой сервера мессенджера при пуше в main (API + веб-клиент)
# Секреты: DEPLOY_HOST, DEPLOY_USER, DEPLOY_SSH_KEY; опционально DEPLOY_PATH (по умолчанию /opt/messenger)

name: Deploy server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Build web client
        run: |
          cd client
          flutter pub get
          flutter build web --release

      - name: Prepare public folder
        run: |
          mkdir -p server/public
          cp -r client/build/web/* server/public/

      - name: Prepare SSH key
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$DEPLOY_SSH_KEY" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keygen -y -f ~/.ssh/deploy_key > /dev/null || (echo 'Invalid SSH key in DEPLOY_SSH_KEY secret' && exit 1)

      - name: Deploy API via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/opt/messenger' }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key_path: ~/.ssh/deploy_key
          envs: DEPLOY_PATH
          script: |
            set -e
            cd "$DEPLOY_PATH"
            git fetch origin main
            git reset --hard origin/main
            cd server
            npm ci --omit=dev
            mkdir -p public
            pm2 restart messenger || (pm2 start index.js --name messenger)
            pm2 save

      - name: Copy web client to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key_path: ~/.ssh/deploy_key
          source: "server/public"
          target: "${{ secrets.DEPLOY_PATH || '/opt/messenger' }}/server"
