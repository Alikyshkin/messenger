# Автодеплой сервера мессенджера при пуше в main (API + веб-клиент)
# Секреты: DEPLOY_HOST, DEPLOY_USER, DEPLOY_SSH_KEY; опционально DEPLOY_PATH (по умолчанию /opt/messenger)

name: Deploy server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Build web client
        run: |
          cd client
          flutter pub get
          flutter build web --release

      - name: Prepare public folder
        run: |
          mkdir -p server/public
          cp -r client/build/web/* server/public/

      - name: Prepare SSH key
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          printf '%s\n' "$DEPLOY_SSH_KEY" | tr -d '\r' > "$GITHUB_WORKSPACE/deploy_key"
          chmod 600 "$GITHUB_WORKSPACE/deploy_key"
          ssh-keygen -y -f "$GITHUB_WORKSPACE/deploy_key" > /dev/null || (echo 'Invalid SSH key' && exit 1)

      - name: Copy web client to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          PATH_TO_DEPLOY="${DEPLOY_PATH:-/opt/messenger}"
          scp -o StrictHostKeyChecking=accept-new -i "$GITHUB_WORKSPACE/deploy_key" -r server/public/* "$DEPLOY_USER@$DEPLOY_HOST:$PATH_TO_DEPLOY/server/public/"

      - name: Deploy API via SSH
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          PATH_TO_DEPLOY="${DEPLOY_PATH:-/opt/messenger}"
          ssh -o StrictHostKeyChecking=accept-new -i "$GITHUB_WORKSPACE/deploy_key" "$DEPLOY_USER@$DEPLOY_HOST" "set -e
            cd $PATH_TO_DEPLOY
            git fetch origin main
            git reset --hard origin/main
            mkdir -p data
            cd server
            npm ci --omit=dev
            mkdir -p public
            pm2 restart messenger || (pm2 start index.js --name messenger)
            pm2 save"
