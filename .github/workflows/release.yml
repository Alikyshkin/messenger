name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # Сборка Flutter-приложения для всех платформ
  build-flutter:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: web
            os: ubuntu-latest
          - platform: android
            os: ubuntu-latest
          - platform: linux
            os: ubuntu-latest
          - platform: windows
            os: windows-latest
          - platform: macos
            os: macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.9'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        working-directory: ./client
        run: flutter pub get

      - name: Build Web
        if: matrix.platform == 'web'
        working-directory: ./client
        run: flutter build web --release --no-tree-shake-icons

      - name: Build Android APK
        if: matrix.platform == 'android'
        working-directory: ./client
        run: flutter build apk --release

      - name: Build Linux
        if: matrix.platform == 'linux'
        working-directory: ./client
        run: flutter build linux --release

      - name: Build Windows
        if: matrix.platform == 'windows'
        working-directory: ./client
        run: flutter build windows --release

      - name: Build macOS
        if: matrix.platform == 'macos'
        working-directory: ./client
        run: flutter build macos --release

      - name: Package Web (zip)
        if: matrix.platform == 'web'
        run: |
          cd client/build/web
          zip -r ../../../messenger-web.zip .
          cd ../../..

      - name: Package Linux (zip)
        if: matrix.platform == 'linux'
        run: |
          cd client/build/linux/x64/release/bundle
          zip -r ../../../../../messenger-linux.zip .
          cd ../../..

      - name: Package Windows (zip)
        if: matrix.platform == 'windows'
        run: Compress-Archive -Path client/build/windows/x64/runner/Release/* -DestinationPath client/messenger-windows.zip

      - name: Package macOS (zip)
        if: matrix.platform == 'macos'
        run: |
          cd client/build/macos/Build/Products/Release
          zip -r ../../../../../messenger-macos.zip *.app
          cd ../../../../..

      - name: Upload Web artifact
        if: matrix.platform == 'web'
        uses: actions/upload-artifact@v4
        with:
          name: messenger-web
          path: client/messenger-web.zip

      - name: Upload Android artifact
        if: matrix.platform == 'android'
        uses: actions/upload-artifact@v4
        with:
          name: messenger-android
          path: client/build/app/outputs/flutter-apk/app-release.apk

      - name: Upload Linux artifact
        if: matrix.platform == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: messenger-linux
          path: client/messenger-linux.zip

      - name: Upload Windows artifact
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: messenger-windows
          path: client/messenger-windows.zip

      - name: Upload macOS artifact
        if: matrix.platform == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: messenger-macos
          path: client/messenger-macos.zip

  # Сборка Docker-образа сервера
  build-docker:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/messenger-server:${{ steps.get_version.outputs.VERSION }}
            ${{ secrets.DOCKER_USERNAME }}/messenger-server:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Создание GitHub Release с артефактами (не зависит от Docker — приложение можно выпустить без Docker Hub)
  create-release:
    runs-on: ubuntu-latest
    needs: [build-flutter]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Get changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            # Извлекаем секцию для текущей версии
            VERSION="${{ steps.version.outputs.VERSION }}"
            if grep -q "## \[$VERSION\]" CHANGELOG.md; then
              sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md
            else
              echo "Release $VERSION" > release_notes.md
              echo "" >> release_notes.md
              echo "См. CHANGELOG.md для деталей." >> release_notes.md
            fi
          else
            echo "Release ${{ steps.version.outputs.VERSION }}" > release_notes.md
          fi

      - name: Prepare release files
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p release-files
          [ -f release-artifacts/messenger-web/messenger-web.zip ] && cp release-artifacts/messenger-web/messenger-web.zip "release-files/messenger-web-$VERSION.zip"
          [ -f release-artifacts/messenger-android/app-release.apk ] && cp release-artifacts/messenger-android/app-release.apk "release-files/messenger-android-$VERSION.apk"
          [ -f release-artifacts/messenger-linux/messenger-linux.zip ] && cp release-artifacts/messenger-linux/messenger-linux.zip "release-files/messenger-linux-$VERSION.zip"
          [ -f release-artifacts/messenger-windows/messenger-windows.zip ] && cp release-artifacts/messenger-windows/messenger-windows.zip "release-files/messenger-windows-$VERSION.zip"
          [ -f release-artifacts/messenger-macos/messenger-macos.zip ] && cp release-artifacts/messenger-macos/messenger-macos.zip "release-files/messenger-macos-$VERSION.zip"
          ls -la release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            release-files/messenger-web-*.zip
            release-files/messenger-android-*.apk
            release-files/messenger-linux-*.zip
            release-files/messenger-windows-*.zip
            release-files/messenger-macos-*.zip
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
