# Мессенджер

Простой кроссплатформенный мессенджер для **Web**, Android, iOS, Windows и macOS.

## Возможности

- **Регистрация и вход** по имени пользователя и паролю
- **Чаты** — список диалогов с последним сообщением
- **Контакты** — добавление по имени пользователя, удаление
- **Переписка** в реальном времени (WebSocket)
- **Вложения** — прикрепление файлов к сообщениям (до 15 МБ, изображения отображаются в чате)
- **Звонки** — голосовые и видеозвонки по WebRTC

---

## Скачать приложение под свою ОС

Готовые сборки лежат в [**Releases**](/releases) (вкладка в репозитории). Откройте последний релиз и скачайте файл под свою систему:

| Ваша ОС | Что скачать | Что делать после скачивания |
|---------|-------------|-----------------------------|
| **Android** | `app-release.apk` | Открыть файл на телефоне и разрешить установку из неизвестных источников. Установить приложение. |
| **Windows** | `messenger-windows.zip` | Распаковать архив в любую папку. Запустить `client.exe`. |
| **macOS** | `messenger-macos.zip` | Распаковать архив. Открыть папку и запустить приложение **client** (или перетащить в «Программы»). При первом запуске: «Системные настройки» → «Конфиденциальность и безопасность» → разрешить запуск. |
| **Web** (браузер) | `messenger-web.zip` | Распаковать на веб-сервер (или использовать локально через любой статический сервер). Открыть в браузере по адресу, где раздаётся папка. |

**Важно:** для работы приложения нужен запущенный сервер (см. раздел «Запуск» ниже). Если мессенджер развёрнут у вас или у знакомых — уточните адрес сервера и при необходимости настройте его в приложении.

### Платформы и удобство использования

- **Android / iOS:** долгое нажатие на сообщение — реакции и ответ; кнопки с подсказками (tooltip при длительном нажатии).
- **Web, Windows, macOS:** то же + **правый клик** по сообщению открывает контекстное меню (реакции, ответить, переслать в личном чате). В браузере видеозвонки и видеокружки работают только по **HTTPS**; при открытии по HTTP отображается подсказка.
- **Вложения:** на вебе зашифрованные файлы по нажатию **скачиваются** в папку «Загрузки»; на мобильных и десктопе — открываются во внешнем приложении. Везде доступны выбор и отправка нескольких фото.
- **Реакции на сообщения** (как в Telegram) работают в личных и групповых чатах на всех платформах.

---

## Запуск

### Сервер (обязательно)

```bash
cd server
cp .env.example .env
# Отредактируйте .env: задайте JWT_SECRET (см. раздел «Безопасность»)
npm install
npm start
```

Сервер будет доступен на `http://localhost:3000`. Данные хранятся в файле `server/messenger.db`.

### Клиент (Flutter)

```bash
cd client
flutter pub get
flutter run
```

Выберите устройство: **Chrome** (веб), Android, iOS, Windows, macOS.

**Важно:** для эмулятора Android замените в `client/lib/config.dart` адрес на `http://10.0.2.2:3000`. Для реального телефона укажите IP вашего компьютера в локальной сети.

### Веб-версия

```bash
cd client
flutter run -d chrome
```

Откроется браузер с мессенджером. API на вебе берётся с того же хоста, что и страница, порт 3000 (например `http://localhost:3000` при разработке). Для продакшена раздавайте веб-клиент и API с одного домена или настройте CORS и адрес в коде.

Сборка веб-клиента для деплоя:

```bash
flutter build web
```

Результат в `client/build/web/` — можно положить на любой статический хостинг (Netlify, Vercel, nginx и т.д.).

## Сборка под платформы

- **Web:** `flutter build web` → каталог `build/web/`
- **Android:** `flutter build apk`
- **iOS:** `flutter build ios` (требуется Xcode и macOS)
- **Windows:** `flutter build windows`
- **macOS:** `flutter build macos`

---

## Тестирование

Тесты проверяют, что функционал работает. **В прод они не попадают:** пользовательские сборки и `npm start` тесты не запускают.

### Сервер

```bash
cd server
npm test
```

Запускаются тесты API (регистрация, логин, сброс/смена пароля, пользователи, сообщения). Используется **тестовая БД в памяти** (`MESSENGER_DB_PATH=:memory:`), файл `messenger.db` не трогается. Письма при сбросе пароля не отправляются (SMTP в тестах не настроен).

### Клиент

```bash
cd client
flutter test
```

Запускаются юнит-тесты моделей и сервисов. Папка `test/` в релизные сборки (`flutter build apk`, `flutter build web` и т.д.) **не входит** — пользователи получают только код из `lib/`.

---

## Как выложить на GitHub и раздавать сборки под все ОС

### 1. Создать репозиторий и залить код

На [GitHub](https://github.com/new) создайте новый репозиторий (например `messenger`), затем в папке проекта:

```bash
cd /Users/alikakuznecova/Documents/messenger
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/ВАШ_ЛОГИН/messenger.git
git push -u origin main
```

(Подставьте свой логин и имя репозитория.)

### 2. Включить автоматическую сборку в Release

В репозитории уже есть workflow **Release** (файл `.github/workflows/release.yml`). Он запускается при пуше тега вида `v*` (например `v1.0.0`) и собирает:

- **Android** — APK (`app-release.apk`)
- **Windows** — архив с `.exe` и библиотеками (`messenger-windows.zip`)
- **macOS** — архив с приложением `.app` (`messenger-macos.zip`)
- **Web** — архив с файлами для выкладки на сайт (`messenger-web.zip`)

Сборки появляются в **Releases** на GitHub.

### 3. Создать релиз и скачать сборки

В терминале из корня проекта:

```bash
git tag v1.0.0
git push origin v1.0.0
```

Через несколько минут в репозитории откройте **Releases** (справа блок «Releases» или вкладка **Releases**). Появится релиз **v1.0.0** с прикреплёнными файлами:

| Файл | Для кого |
|------|----------|
| `app-release.apk` | Android — установить на телефон |
| `messenger-windows.zip` | Windows — распаковать и запустить `client.exe` |
| `messenger-macos.zip` | macOS — распаковать и открыть `client.app` |
| `messenger-web.zip` | Web — распаковать на сервер и раздавать как статический сайт |

Пользователи переходят в нужный релиз и скачивают файл под свою ОС.

### 4. Про iOS

Сборка под iOS в этом workflow не настроена (нужны сертификаты и подпись в Xcode). Версию для iPhone/iPad можно собирать вручную на Mac: `cd client && flutter build ios`, либо позже добавить отдельный job с подписью через секреты.

## Где хранятся данные и как они защищены

| Данные | Где хранятся | Защита |
|--------|----------------|--------|
| **Пароли** | Сервер, таблица `users` | Не хранятся в открытом виде: только хеш bcrypt. Подобрать пароль по хешу практически невозможно. |
| **Переписки** | Сервер, таблица `messages` | Текст сообщений шифруется **на устройстве пользователя** (E2EE): ключи хранятся только на клиенте (secure storage). Сервер сохраняет уже зашифрованный текст и не может его прочитать. Алгоритм: X25519 (ECDH) + HKDF + AES-256-GCM. |
| **Ключи E2EE** | Только на устройстве пользователя (клиент) | Приватный ключ — в secure storage; публичный отправляется на сервер для обмена с контактами. Сервер не хранит приватных ключей. |
| **Логины (username)** | Сервер, БД | Хранятся открыто (нужны для входа и поиска). Не пароли. |
| **JWT-токены** | Только на устройстве пользователя (клиент) | Подписываются секретом `JWT_SECRET`. В продакшене задайте длинный случайный `JWT_SECRET` в `.env`. |

**Первый запуск:** скопируйте `server/.env.example` в `server/.env` и задайте в `.env` свои значения:
- `JWT_SECRET` — длинная случайная строка (например сгенерированная парольной программой).
- `ENCRYPTION_KEY` — необязательно; только для расшифровки старых сообщений, если они были зашифрованы на сервере до перехода на E2EE.

**Важно:** по сети всё должно идти по **HTTPS** (и WSS для WebSocket). На хостинге включите SSL (Let's Encrypt) и в клиенте укажите `https://` в `config.dart`.

---

## Хостинг (где держать сервер и данные)

Всё хранится на **вашем сервере**: один файл БД `messenger.db` и процесс Node.js. Варианты:

1. **VPS (сервер в облаке)**  
   Арендуете виртуальный сервер (например **Hetzner**, **DigitalOcean**, **Selectel**, **Timeweb**), ставите Node.js, клонируете репозиторий, настраиваете `.env`, запускаете `npm start`.  
   - Плюсы: полный контроль, данные у вас, можно настроить бэкапы диска.  
   - **Автодеплой:** при пуше в `main` сервер может обновляться сам (GitHub Actions подключается по SSH и перезапускает приложение). Подробно: [docs/deploy-server.md](docs/deploy-server.md).  
   - Бэкапы: делайте копию `server/messenger.db` (например по расписанию через cron) и храните в отдельном месте.

2. **PaaS (платформа)**  
   **Railway**, **Render**, **Fly.io** — заливаете код, задаёте переменные `JWT_SECRET`, `PORT`.  
   - Учтите: у многих PaaS диск эфемерный (при перезапуске данные теряются). Нужен либо встроенный объём (persistent volume), либо внешняя БД. Для SQLite на Railway/Render часто используют постоянный диск или переходят на PostgreSQL.

3. **Свой компьютер**  
   Можно запускать сервер у себя и открыть порт (или использовать ngrok/Cloudflare Tunnel). Данные тогда только на вашем ПК; бэкап — копировать папку `server/` и особенно `messenger.db`.

**Рекомендация для начала:** VPS с Ubuntu, установить Node, настроить Nginx + Let's Encrypt для HTTPS, в cron раз в день копировать `messenger.db` в бэкап.

---

## Как у других мессенджеров

В проекте реализованы подходы, описанные в обзоре: [docs/how-messengers-store-data.md](docs/how-messengers-store-data.md).

- **Local-first:** источник правды для экранов — локальная SQLite; данные с сервера подмешиваются при загрузке и по WebSocket.
- **Офлайн:** при отсутствии сети сообщения попадают в очередь и отправляются автоматически при появлении связи.
- **E2E:** ключи шифрования хранятся только на устройствах пользователей (как в Signal/WhatsApp).

## Стек

- **Клиент:** Flutter (Dart), Provider, HTTP, WebSocket, SQLite (локальный кэш), E2EE (cryptography, flutter_secure_storage), connectivity_plus
- **Сервер:** Node.js, Express, SQLite, JWT, WebSocket (ws)

## Структура

```
messenger/
├── server/           # Backend API и WebSocket
│   ├── index.js
│   ├── db.js
│   ├── auth.js
│   ├── realtime.js
│   └── routes/
├── client/            # Flutter приложение
│   └── lib/
│       ├── main.dart
│       ├── config.dart
│       ├── database/   # локальная SQLite (чаты, сообщения, outbox)
│       ├── models/
│       ├── services/
│       └── screens/
└── README.md
```
