# Миграция с PM2 на Docker

Если у вас уже запущено приложение через PM2, и вы хотите перейти на Docker, нужно выполнить миграцию, чтобы избежать конфликта портов.

## Проблема

Оба способа запуска (PM2 и Docker) пытаются использовать **порт 3000**, что вызывает конфликт:
- PM2 запускает `node index.js` напрямую на сервере → порт 3000
- Docker контейнер тоже слушает порт 3000 → конфликт!

## Решение: Миграция на Docker

### Вариант 1: Полная миграция (рекомендуется)

**Шаг 1: Остановите PM2 процесс**

```bash
ssh ваш_пользователь@ваш_сервер
pm2 stop messenger
pm2 delete messenger
pm2 save
```

**Шаг 2: Настройте Docker (см. `docs/server-docker-setup.md`)**

**Шаг 3: Запустите через Docker**

```bash
cd /opt/messenger
docker compose up -d
```

**Готово!** Теперь приложение работает только через Docker.

### Вариант 2: Временное сосуществование (для тестирования)

Если хотите протестировать Docker, пока PM2 еще работает:

**Измените порт в docker-compose.yml:**

```yaml
ports:
  - "3001:3000"  # Внешний порт 3001, внутренний 3000
```

Тогда:
- PM2 будет на порту 3000
- Docker будет на порту 3001

После тестирования остановите PM2 и верните порт обратно на 3000.

## Автоматическая миграция

GitHub Actions workflow **автоматически останавливает PM2** перед запуском Docker при деплое. Но для первого запуска лучше сделать это вручную.

## Проверка

После миграции проверьте:

```bash
# PM2 не должен быть запущен
pm2 status
# Должно быть пусто или messenger должен быть stopped/deleted

# Docker контейнер должен работать
docker compose ps
# Должен быть статус "Up"

# Проверьте порт
netstat -tulpn | grep 3000
# Должен быть только Docker процесс
```

## Откат на PM2 (если нужно)

Если что-то пошло не так и хотите вернуться на PM2:

```bash
# Остановите Docker
cd /opt/messenger
docker compose down

# Запустите PM2
cd /opt/messenger/server
pm2 start index.js --name messenger
pm2 save
```

## Преимущества Docker

После миграции вы получите:
- ✅ Автоматические обновления через GitHub Actions
- ✅ Изолированное окружение
- ✅ Проще управление зависимостями
- ✅ Легче масштабирование

## Важные моменты

1. **Данные сохраняются:** Volumes в Docker используют те же директории (`./data`, `./uploads`, `./public`), так что данные не потеряются.

2. **Переменные окружения:** Убедитесь, что в `docker-compose.yml` настроены все нужные переменные из `.env`.

3. **PM2 startup:** Если PM2 был настроен на автозапуск (`pm2 startup`), отключите его:
   ```bash
   pm2 unstartup
   ```

4. **Docker автозапуск:** Docker Compose с `restart: unless-stopped` автоматически перезапускает контейнер после перезагрузки сервера.
