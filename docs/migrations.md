# Database Migrations

Система миграций позволяет управлять изменениями схемы базы данных версионированным способом.

## Структура

- `server/migrations/index.js` - основной модуль для применения миграций
- `server/migrations/versions/` - директория с SQL файлами миграций
- Формат имени файла: `{номер}_{название}.sql` (например, `001_initial_schema.sql`)

## Применение миграций

Миграции применяются автоматически при запуске сервера. Также можно применить их вручную:

```bash
npm run migrate
```

Или с указанием пути к базе данных:

```bash
node scripts/migrate.js /path/to/database.db
```

## Создание новой миграции

1. Создайте новый файл в `server/migrations/versions/` с номером следующей миграции
2. Формат имени: `{номер}_{описание}.sql`
3. Номер должен быть больше всех существующих миграций
4. Напишите SQL для изменения схемы

Пример:

```sql
-- Миграция 004: Добавление новой таблицы
CREATE TABLE IF NOT EXISTS new_table (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL
);
```

## Отслеживание миграций

Система отслеживает применённые миграции в таблице `schema_migrations`:

```sql
SELECT * FROM schema_migrations ORDER BY version;
```

## Важные замечания

- Миграции применяются в порядке номеров версий
- Каждая миграция выполняется в транзакции
- Если миграция падает, транзакция откатывается
- Используйте `IF NOT EXISTS` для безопасного создания объектов
- Для изменения существующих таблиц используйте `ALTER TABLE`
- Не удаляйте уже применённые миграции из директории

## Обратная совместимость

Существующий код в `db.js` остаётся для обратной совместимости. Новые изменения схемы должны добавляться через миграции.
