# Как крупные мессенджеры хранят и обрабатывают данные

Краткий обзор подходов Telegram, WhatsApp/Signal и общие практики — чтобы ориентироваться при доработке своего мессенджера.

---

## Telegram

### Архитектура

- **Три слоя:** API (запросы/ответы в бинарном виде), криптослой (MTProto), транспорт (HTTP/HTTPS/WebSocket, TCP, UDP).
- Поддержка больших файлов (до 4 ГБ), оптимизация под мобильные сети.

### Два режима чатов

| Режим | Шифрование | Где хранятся сообщения | Синхронизация |
|-------|------------|------------------------|---------------|
| **Cloud Chats** | клиент–сервер (MTProto 2.0) | На серверах Telegram + локально в клиенте | Все устройства, облачный поиск, медиа |
| **Secret Chats** | сквозное (E2E) | Только на двух устройствах участников | Только эта пара устройств, в облако не попадает |

### Шифрование (MTProto 2.0)

- **Cloud:** AES-256 (IGE), ключ сессии через Diffie–Hellman при авторизации, SHA-256 для аутентификации сообщений. Сервер может расшифровать (для облака и синхронизации).
- **Secret Chats:** дополнительный E2E-слой поверх клиент–сервер, ключи только у отправителя и получателя.
- Perfect Forward Secrecy есть и в облачных, и в секретных чатах.

### Локальное хранение (клиент)

- **SQLite** на каждом устройстве: история, кэш медиа.
- **Расположение:** например Android — `cache4.db`, десктоп — `tdata/.../map1`, iOS — в песочнице приложения.
- База может быть **зашифрована** (зависит от клиента/настроек).
- Удаление в UI часто = флаг `deleted=1`, а не физическое удаление строк (для совместимости и восстановления).
- Очистка кэша/вакуум по политике «хранить медиа N дней».

### Вывод по Telegram

- Облако = быстрая синхронизация и поиск, но сервер имеет доступ к тексту (в cloud chats).
- Секретные чаты и звонки — E2E, ключи только у пользователей.
- Локально — своя копия в SQLite, бинарный протокол, одна учётная запись на много устройств.

---

## WhatsApp / Signal

### Протокол

- **Signal Protocol** — сквозное шифрование (E2E): шифруют на устройстве отправителя, сервер не может прочитать.
- Ключи генерируются и хранятся на устройствах; сервер только маршрутизирует зашифрованные сообщения.

### Роль сервера

- Сообщения приходят на сервер **уже зашифрованными**.
- Сервер не хранит ключи расшифровки — только доставка и офлайн-очередь.
- Офлайн: сообщения лежат на сервере в зашифрованном виде, затем удаляются после доставки (у WhatsApp — до 30 дней).

### Хранение на сервере

- Очереди/временное хранение в зашифрованном виде (key-value, шардирование).
- После доставки или по истечении срока сообщения удаляются с сервера.

### Локально (клиент)

- Своя локальная БД (SQLite и т.п.) для истории, чтобы приложение работало офлайн и быстро открывало чаты.
- Ключи E2E хранятся на устройстве (защищённое хранилище).

### Вывод по WhatsApp/Signal

- Максимальная приватность: сервер не видит текст.
- Сложнее: синхронизация нескольких устройств (свои ключи на каждом), нет облачного поиска по тексту на сервере.

---

## Общие практики мессенджеров

### 1. Local-first

- **Источник правды — локальная БД**, а не сеть.
- Схема: UI → локальная БД → движок синхронизации → сеть.
- Плюсы: быстрый отклик, работа офлайн, меньше зависимость от задержек сети.

### 2. Синхронизация

- Не «каждый раз качать всё», а **снимок + дельты**: один раз загрузить состояние, дальше подписываться на обновления (push, WebSocket, long polling).
- Экономия трафика и нагрузки (как в Facebook Messenger с переходом на Thrift и дельты).

### 3. Офлайн и конфликты

- Включённая **дисковая персистентность**: очередь отправки и кэш сохраняются при перезапуске.
- При нескольких устройствах/офлайне — явная политика разрешения конфликтов; в продвинутых системах используют **CRDT** или аналоги для сходимости без потерь.

### 4. Формат и размер

- Бинарные протоколы (как MTProto, Thrift) часто дают меньший размер и быстрее парсятся, чем JSON по сети.
- Для своего мессенджера на старте JSON допустим; при росте можно подумать о бинаре.

### 5. Локальная БД в клиенте

- **SQLite** — типичный выбор (Telegram, много других).
- Хранить: пользователей, чаты, сообщения, контакты, очередь исходящих.
- Синхронизация: «подтянуть с сервера недостающее» и «отправить из очереди при появлении сети».

---

## Что уже есть у нашего мессенджера и что можно добавить

| Аспект | Сейчас | Как у крупных |
|--------|--------|----------------|
| **Пароли** | bcrypt на сервере | Аналогично (хеш, не пароль) ✓ |
| **Текст сообщений на сервере** | E2E: ключи только на устройствах, сервер хранит зашифрованное (X25519 + AES-GCM) | Как WhatsApp/Signal ✓ |
| **Транспорт** | HTTP + WebSocket | HTTPS + WSS в проде ✓ |
| **Локальная БД в приложении** | SQLite в клиенте: чаты, сообщения, очередь отправки | Как у Telegram/Signal ✓ |
| **Синхронизация** | Local-first: сначала показ из кэша, затем подтягивание с сервера + WebSocket для новых сообщений | Снимок + дельты, push ✓ |
| **Офлайн** | Очередь отправки (outbox), при появлении сети — автоматическая отправка; история из локальной БД | Очередь отправки, показ из кэша ✓ |

Итого: мессенджер реализует подход, близкий к крупным: **локальная SQLite как источник правды для UI**, **E2E-шифрование с ключами на устройстве**, **офлайн-очередь отправки** и **синхронизация с сервером** при открытии и по WebSocket.
