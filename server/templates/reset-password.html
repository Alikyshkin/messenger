<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Сброс пароля</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 400px; margin: 2rem auto; padding: 1rem; }
    h1 { font-size: 1.25rem; }
    input { width: 100%; padding: 0.5rem; margin: 0.5rem 0; box-sizing: border-box; }
    button { padding: 0.6rem 1.2rem; margin-top: 0.5rem; cursor: pointer; }
    .error { color: #c00; font-size: 0.9rem; }
    .success { color: #080; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Новый пароль</h1>
  <form id="form" method="post" action="/auth/reset-password">
    <input type="hidden" name="token" value="{{TOKEN}}">
    <label>Новый пароль (мин. 6 символов)</label>
    <input type="password" name="newPassword" required minlength="6" autocomplete="new-password">
    <label>Повторите пароль</label>
    <input type="password" id="confirm" required minlength="6" autocomplete="new-password">
    <div id="msg" class="error"></div>
    <button type="submit">Сохранить пароль</button>
  </form>
  <script>
    var form = document.getElementById('form');
    var confirm = document.getElementById('confirm');
    var msg = document.getElementById('msg');
    form.addEventListener('submit', function(e) {
      if (document.querySelector('input[name="newPassword"]').value !== confirm.value) {
        e.preventDefault();
        msg.textContent = 'Пароли не совпадают';
        return;
      }
      msg.textContent = '';
    });
    form.addEventListener('submit', function(e) {
      if (e.defaultPrevented) return;
      e.preventDefault();
      var fd = new FormData(form);
      fetch(form.action, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token: fd.get('token'), newPassword: fd.get('newPassword') }) })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, d: d }; }); })
        .then(function(_) {
          if (_.ok) { msg.className = 'success'; msg.textContent = 'Пароль изменён. Можете войти в приложение.'; form.reset(); }
          else { msg.className = 'error'; msg.textContent = _.d.error || 'Ошибка'; }
        })
        .catch(function() { msg.className = 'error'; msg.textContent = 'Ошибка сети'; });
    });
  </script>
</body>
</html>
